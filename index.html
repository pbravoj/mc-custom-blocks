function update() {
    var pos = document.getElementById('p').value;
    var lay = document.getElementById('l').value;

    // --- SECCIÓN 1: LÓGICA DE DATOS (Encapsulada para el SDK) ---
    var logic = '%%[' +
        /* 1. Definición de Posición elegida en el formulario */
        ' SET @ItemIndex = ' + pos + ' ' +
        ' SET @LayoutName = "' + lay + '" ' +

        /* 2. Recuperación de Campaign_ID de la Audiencia */
        ' SET @CampID = AttributeValue("Campaign_ID") ' +
        ' IF Empty(@CampID) THEN SET @CampID = "SKU_PARAMETRICO" ENDIF ' +

        /* 3. Búsqueda de SKU en Configuración */
        ' SET @ColumnaSKU = Concat("SKU_", @ItemIndex) ' +
        ' SET @SKU = Lookup("Campanas_Config_DE", @ColumnaSKU, "Campaign_ID", @CampID) ' +

        /* 4. Lógica de Producto (Solo si hay SKU) */
        ' IF NOT Empty(@SKU) THEN ' +
        
            /* A. Construcción de URL de Imagen (TU LÓGICA DE PREFIJO/SUFIJO) */
            ' SET @PrefijoUrl = "https://images.implementos.cl/img/1000/" ' +
            ' SET @SufijoUrl  = "-1.jpg" ' +
            ' SET @Imagen = Concat(@PrefijoUrl, @SKU, @SufijoUrl) ' +

            /* B. Recuperación desde Master_Products_DE */
            ' SET @Filas = LookupRows("Master_Products_DE", "SKU", @SKU) ' +
            ' IF RowCount(@Filas) > 0 THEN ' +
                ' SET @Fila = Row(@Filas, 1) ' +
                ' SET @Nombre = Field(@Fila, "NOMBRE") ' +
                ' SET @Precio = Field(@Fila, "PRECIO_MESON") ' +
                ' SET @DescL1 = Field(@Fila, "DESCRIP_L1") ' +
                ' SET @DescL2 = Field(@Fila, "DESCRIP_L2") ' +
                ' SET @Descripcion = Concat(@DescL1, " ", @DescL2) ' +
                ' SET @PrecioFinal = FormatCurrency(@Precio, "es-CL") ' +
            ' ELSE ' +
                ' SET @Nombre = "Producto no encontrado" ' +
                ' SET @Descripcion = "Sin descripción disponible." ' +
                ' SET @PrecioFinal = "" ' +
            ' ENDIF ' +
        ' ENDIF ' +
        ']%%';

    // --- SECCIÓN 2: RENDERIZADO ---
    // Esto llama al bloque HTML que guardaste en Content Builder
    var render = '%%[ OUTPUT(ContentBlockByName(Concat("Content Builder\\BPP\\", @LayoutName))) ]%%';

    // Inyectamos todo al editor de Salesforce
    sdk.setContent(logic + render);

    // --- SECCIÓN 3: MINIATURA ---
    sdk.setAsset({
        "metaData": {
            "thumbnail": { 
                "url": "https://image.cl-implementos.cl/lib/fe2b11737164057a7d1676/m/1/a72fde74-d3e3-4dac-b9c2-72e747947e81.jpg" 
            }
        }
    });
}
